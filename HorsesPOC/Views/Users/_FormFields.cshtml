@model HorsesPOC.Models.Domain.user

@{
    var isEdit = Model?.Id != Guid.Empty;
    ViewData["Title"] = isEdit ? "Edit User" : "Create User";
}

<h2 class="mb-3">@ViewData["Title"]</h2>

<form asp-action="@(isEdit ? "Edit" : "Create")" method="post" novalidate class="mt-3">
    @Html.AntiForgeryToken()
    @if (isEdit)
    {
        <input type="hidden" asp-for="Id" />
    }

    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="Name" class="form-label">Full name</label>
                    <input asp-for="Name" class="form-control" placeholder="e.g., Ahmed Saleh" />
                    <span asp-validation-for="Name" class="text-danger small"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="UserName" class="form-label">Username</label>
                    @if (isEdit)
                    {
                        <input asp-for="UserName" class="form-control" readonly />
                        <div class="form-text">Username cannot be changed.</div>
                    }
                    else
                    {
                        <input asp-for="UserName" class="form-control" autocomplete="username" />
                    }
                    <span asp-validation-for="UserName" class="text-danger small"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="PhoneNumber" class="form-label">Phone number</label>
                    <input asp-for="PhoneNumber" class="form-control" type="tel" inputmode="tel" placeholder="e.g., +9665XXXXXXXX" pattern="^\+?\d{7,15}$" />
                    <div class="form-text">Digits only, optionally starting with + (7–15 digits).</div>
                    <span asp-validation-for="PhoneNumber" class="text-danger small"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="NID" class="form-label">National ID</label>
                    <input asp-for="NID" class="form-control" inputmode="numeric" pattern="^\d{8,20}$" />
                    <div class="form-text">Digits only.</div>
                    <span asp-validation-for="NID" class="text-danger small"></span>
                </div>

                <div class="col-md-6 position-relative">
                    <label asp-for="Password" class="form-label">@(isEdit ? "New Password" : "Password")</label>
                    <input asp-for="Password" type="password" class="form-control" id="PasswordField" autocomplete="new-password" />
                    <button type="button" class="btn btn-sm btn-outline-secondary position-absolute top-50 end-0 translate-middle-y me-2" data-toggle-target="PasswordField">Show</button>
                    <div class="progress mt-2" aria-hidden="true">
                        <div id="pwdStrengthBar" class="progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="form-text">Use at least 8 characters. Leave blank to keep current password.</div>
                    @* <span asp-validation-for="Password" class="text-danger small"></span> *@
                </div>

                @if (!isEdit)
                {
                    <div class="col-md-6 position-relative">
                        <label for="ConfirmPasswordField" class="form-label">Confirm password</label>
                        <input name="confirmPassword" type="password" class="form-control" id="ConfirmPasswordField" autocomplete="new-password" />
                        <button type="button" class="btn btn-sm btn-outline-secondary position-absolute top-50 end-0 translate-middle-y me-2" data-toggle-target="ConfirmPasswordField">Show</button>
                        <div class="invalid-feedback d-block" id="confirmHelp" style="display:none;">Passwords do not match.</div>
                    </div>
                }

                <div class="col-md-6">
                    <label asp-for="UserType" class="form-label">Role</label>
                    <select asp-for="UserType" class="form-select" asp-items="ViewBag.UserTypes"></select>
                    <span asp-validation-for="UserType" class="text-danger small"></span>
                </div>
            </div>
        </div>
        @* <div class="card-footer d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle me-1"></i> @(isEdit ? "Save" : "Create")
            </button>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="bi bi-x-circle me-1"></i> Cancel
            </a>
        </div> *@
    </div>
</form>


@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // password show/hide buttons
        document.querySelectorAll('[data-toggle-target]').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-toggle-target');
                const input = document.getElementById(id);
                if (!input) return;
                const isPwd = input.type === 'password';
                input.type = isPwd ? 'text' : 'password';
                btn.textContent = isPwd ? 'Hide' : 'Show';
            });
        });

        // simple strength meter (length + variety)
        const pwd = document.getElementById('PasswordField');
        const bar = document.getElementById('pwdStrengthBar');
        function scorePwd(v){
            if(!v) return 0;
            let s = 0;
            if (v.length >= 8) s += 25;
            if (/[A-Z]/.test(v)) s += 20;
            if (/[a-z]/.test(v)) s += 20;
            if (/[0-9]/.test(v)) s += 20;
            if (/[^A-Za-z0-9]/.test(v)) s += 15;
            return Math.min(100, s);
        }
        function updateBar(){
            const val = pwd?.value || '';
            const pct = scorePwd(val);
            bar.style.width = pct + '%';
            bar.className = 'progress-bar ' + (pct < 40 ? 'bg-danger' : pct < 70 ? 'bg-warning' : 'bg-success');
        }
        pwd?.addEventListener('input', updateBar); updateBar();

        // confirm password check on create
        const confirm = document.getElementById('ConfirmPasswordField');
        const help = document.getElementById('confirmHelp');
        function checkMatch(){
            if(!confirm) return true; // edit mode
            const ok = (confirm.value || '') === (pwd?.value || '');
            help.style.display = ok ? 'none' : 'block';
            return ok;
        }
        confirm?.addEventListener('input', checkMatch);
        pwd?.addEventListener('input', checkMatch);

        // prevent submit if confirm mismatch (create only)
        document.querySelector('form').addEventListener('submit', function(e){
            if (!checkMatch()) { e.preventDefault(); }
        });
    </script>
}